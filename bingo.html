<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=.80">
    <title>I.E.N. Bingo</title>
    <style>
        body {
            background-color: black;
            color: #edbc00; /* Deeper gold color */
            font-family: Arial, sans-serif;
            text-align: center;
            position: relative; /* Allows positioning the user button */
        }

        h1 {
            margin-top: 20px;
        }

        .bingo-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr); /* 3 columns wide */
            grid-gap: 10px;
            margin: 20px auto;
            width: 80%;
        }

        .bingo-cell {
            border: 2px solid #edbc00; /* Deeper gold */
            padding: 20px;
            font-size: 1.2em;
            cursor: pointer;
        }

        .free-spot {
            font-weight: bold;
        }

        .clicked {
            background-color: #DAA520;
            color: black;
        }

        .submit-button {
            margin-top: 20px;
            padding: 10px 20px;
            font-size: 1.2em;
            background-color: #edbc00;
            color: black;
            border: none;
            cursor: pointer;
        }

        .submit-button:hover {
            background-color: #c89700;
        }

        .points-display {
            position: absolute;
            top: 20px;
            right: 20px;
            font-size: 1.5em;
        }

        .user-button {
            position: absolute;
            top: 20px;
            left: 20px;
            padding: 1.25px 2.5px;
            font-size: 1.2em;
            background-color: transparent;
            border: 2px solid #edbc00; /* Button outline */
            color: #edbc00;
            cursor: pointer;
            transition: background-color 0.3s, color 0.3s;
        }

        .user-button:hover {
            background-color: #edbc00;
            color: black;
        }
        
        .hidden {
            display: none;
        }
        
        .rules-section {
            margin: 20px 0;
            color: #edbc00;
            text-align: center;
        }

        .button-section {
            display: flex;
            justify-content: space-between;
            margin-top: 20px;
        }

        .submit-button {
            flex: 1;
            margin: 0 10px;
        }

        .idle-message {
            margin-top: 30px;
            font-size: 1.5em;
            color: #edbc00;
        }
    </style>
</head>
<body>
    <button id="user-button" class="user-button">User</button>

    <h1 id="game-message">I.E.N. Bingo</h1>

    <div class="points-display hidden">
        Points: <span id="points-game">0</span>
    </div>

    <div id="countdown-timer" class="hidden" style="color: red; font-size: 1.5em; font-weight: bold;"></div>

    <div class="bingo-grid hidden">
        <div class="bingo-cell" id="cell-1"></div>
        <div class="bingo-cell" id="cell-2"></div>
        <div class="bingo-cell" id="cell-3"></div>
        <div class="bingo-cell" id="cell-4"></div>
        <div class="bingo-cell" id="cell-5"></div>
        <div class="bingo-cell" id="cell-6"></div>
        <div class="bingo-cell" id="cell-7"></div>
        <div class="bingo-cell free-spot" id="free-spot">Free Spot</div>
        <div class="bingo-cell" id="cell-9"></div>
        <div class="bingo-cell" id="cell-10"></div>
        <div class="bingo-cell" id="cell-11"></div>
        <div class="bingo-cell" id="cell-12"></div>
        <div class="bingo-cell" id="cell-13"></div>
        <div class="bingo-cell" id="cell-14"></div>
        <div class="bingo-cell" id="cell-15"></div>
    </div>

    <div class="rules-section hidden">
        <h2>Game Rules</h2>
        <p>1. Each box = 1 point.</p>
        <p>2. Each row = 2 points.</p>
        <p>3. Each column = 3 points.</p>
        <p>4. Winner announced upon game end.</p>
    </div>

    <h1 class="idle-message hidden" id="idle-message">No game scheduled, check back soon! ...but while I gotcha, why not suggest a new phrase!</h1>

    <div class="button-section">
       <button class="submit-button" onclick="window.location.href='leaderboard.html';">Leaderboards</button> 
       <button class="submit-button" onclick="window.location.href='submit.html';">Submit a Phrase</button>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.3.1/firebase-app.js";
        import { getFirestore, doc, setDoc, getDoc, updateDoc, increment, query, collection, where, getDocs, onSnapshot } from "https://www.gstatic.com/firebasejs/10.3.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDQ0kenGUnwgbZwTgTdqUQHgJWIL25i7hc",
            authDomain: "ien-bingo.firebaseapp.com",
            projectId: "ien-bingo",
            storageBucket: "ien-bingo.appspot.com",
            messagingSenderId: "115041832401",
            appId: "1:115041832401:web:785da7558648d1ac8124f0"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        let countdownTimer;
        const user = JSON.parse(localStorage.getItem('bingoUser'));
        let points = parseInt(localStorage.getItem('pointsThisGame')) || 0;

        if (!user) {
            window.location.href = 'index.html'; // Redirect to login if not authenticated
        }

        document.getElementById('user-button').textContent = user.name;

        document.getElementById('user-button').addEventListener('click', function() {
            window.location.href = 'user_profile.html'; // Adjust the URL as needed
        });

        function monitorGameState() {
            const gameStateRef = doc(db, "game_state", "current");

            onSnapshot(gameStateRef, (doc) => {
                if (doc.exists()) {
                    const gameState = doc.data();
                    const gameStatus = gameState.status;
                    const startTime = gameState.startTime;
                    const endTime = gameState.endTime;

                    if (gameStatus === "idle") {
                        document.getElementById("idle-message").classList.remove('hidden');
                        hideGameElements();
                    } else if (gameStatus === "scheduled") {
                        showCountdown(startTime, endTime);
                    } else if (gameStatus === "started") {
                        showGameElements();
                        populateBingoGrid();
                    } else if (gameStatus === "ended") {
                        endGame(); // Automatically end the game when status changes to "ended"
                    }
                } else {
                    alert("Game state not found.");
                }
            });
        }        

        function showCountdown(startTime, endTime) {
            document.querySelector('.rules-section').classList.add('hidden');
            document.querySelector('.bingo-grid').classList.add('hidden');
            document.getElementById("countdown-timer").classList.remove('hidden');
            document.getElementById("idle-message").classList.add('hidden');

            const startTimeFormatted = new Date(startTime).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            const endTimeFormatted = new Date(endTime).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });

            const totalDurationHours = ((endTime - startTime) / (1000 * 60 * 60)).toFixed(2); // Duration in hours

            document.getElementById("game-message").innerHTML = `
                <p>Next Game Starts:</p> 
                <p>${startTimeFormatted}</p>
                <p>Game Ends:</p>
                <p>${endTimeFormatted}</p>
                <p>Game Duration:</p>
                <p>${totalDurationHours} Hours</p>
            `;

            let [timeString, ampm] = startTimeFormatted.split(" ");
            let [startHours, startMinutes] = timeString.split(":").map(Number);

            if (ampm === "PM" && startHours !== 12) {
                startHours += 12; // Convert PM to 24-hour format
            } else if (ampm === "AM" && startHours === 12) {
                startHours = 0; // Handle 12 AM as 0 hours
            }

            console.log(`Game Start Time (military): ${startHours}:${startMinutes}`);

            startMinutes -= 1;
            startCountdown(startHours, startMinutes);
        }

        let bingoCells; // Declare globally at the top of the script

        function startCountdown(startHours, startMinutes) {
            const countdownDisplay = document.getElementById("countdown-timer");
            clearInterval(countdownTimer);

            countdownTimer = setInterval(() => {
                const now = new Date();
                const currentHours = now.getHours();
                const currentMinutes = now.getMinutes();
                const currentSeconds = now.getSeconds();

                console.log(`Current Time: ${currentHours}:${currentMinutes}:${currentSeconds}`);

                let remainingHours = startHours - currentHours;
                let remainingMinutes = startMinutes - currentMinutes;
                let remainingSeconds = 59 - currentSeconds;

                if (remainingSeconds < 0) {
                    remainingSeconds = 59;
                    remainingMinutes -= 1;
                }

                if (remainingMinutes < 0) {
                    remainingMinutes = 59;
                    remainingHours -= 1;
                }

                if (remainingHours < 0) {
                    remainingHours += 24;  
                }

                const displayHours = remainingHours % 12 || 12; 
                const ampm = remainingHours >= 12 ? 'PM' : 'AM';
                let timeString = `${pad(remainingHours)}:${pad(remainingMinutes)}:${pad(remainingSeconds)}`;
                
                countdownDisplay.innerHTML = `GAME BEGINS IN: ${timeString}`;
                console.log(`Remaining Time - Hours: ${remainingHours}, Minutes: ${remainingMinutes}, Seconds: ${remainingSeconds}`);

                if (remainingHours <= 0 && remainingMinutes <= 0 && remainingSeconds <= 0) {
                    clearInterval(countdownTimer);
                    countdownDisplay.innerHTML = "GAME STARTED!";
                    console.log("Countdown finished, game started!");
                }
            }, 250);
        }

        function pad(num) {
            return num.toString().padStart(2, '0');
        }

        function hideGameElements() {
            document.querySelector('.bingo-grid').classList.add('hidden');
            document.querySelector('.rules-section').classList.add('hidden');
            document.querySelector('.points-display').classList.add('hidden');
            document.getElementById("countdown-timer").classList.add('hidden');
        }

        function showGameElements() {
            document.querySelector('.bingo-grid').classList.remove('hidden');
            document.querySelector('.rules-section').classList.remove('hidden');
            document.querySelector('.points-display').classList.remove('hidden');
        }

        async function populateBingoGrid() {
            const savedBoard = await fetchSavedBoard();
            if (savedBoard) {
                fillBingoGrid(savedBoard);
                await loadClickedCells();
                awardPoints();
            } else {
                clearGameMessage();
                resetGameMessage();
                await generateAndSaveBingoBoard();
            }
        }

        async function loadClickedCells() {
            const userDocRef = doc(db, "user_clicks", user.name);
            const userDocSnap = await getDoc(userDocRef);

            if (userDocSnap.exists()) {
                const userData = userDocSnap.data();
                const clickedCells = userData.clickedCells || [];
                let clickedIndices = clickedCells.map(cell => cell.cellIndex);

                updateClickedCells(clickedIndices);
                awardPoints(clickedCells);
            }
        }

        function updateClickedCells(clickedIndices) {
            bingoCells.forEach((cell, index) => {
                if (clickedIndices.includes(index)) {
                    cell.classList.add('clicked');
                } else {
                    cell.classList.remove('clicked');
                }
            });
        }

        function awardPoints(clickedCells = []) {
            if (!Array.isArray(clickedCells)) clickedCells = [];

            const cellIndices = clickedCells.map(cell => cell.cellIndex);
            const clickedTimes = clickedCells.map(cell => cell.timeClicked || "00:00");

            const horizontalBingos = checkHorizontalBingo(cellIndices, clickedTimes);
            const verticalBingos = checkVerticalBingo(cellIndices, clickedTimes);
            const fullBoard = checkFullBoard(cellIndices, clickedTimes);
            const letterI = checkLetterI(cellIndices);
            const letterH = checkLetterH(cellIndices);

            points = clickedCells.length;
            points += horizontalBingos * 2;
            points += verticalBingos * 3;
            points += letterI ? 6 : 0;
            points += letterH ? 8 : 0;

            if (fullBoard) {
                points += 14;
            }

            updatePointsDisplay();
            localStorage.setItem('pointsThisGame', points);
            updateCompletionStatusInFirebase(horizontalBingos, verticalBingos, fullBoard);
            savePointsToFirestore();
        }

         // Fetch the saved bingo board from Firestore
        async function fetchSavedBoard() {
            const boardDocRef = doc(db, "game_state", "current");
            const boardDocSnap = await getDoc(boardDocRef);

            if (boardDocSnap.exists()) {
                const gameData = boardDocSnap.data();
                return gameData.board || null;
            }
            return null;
        }


        async function updateCompletionStatusInFirebase(horizontalBingos, verticalBingos, fullBoard) {
            const userDocRef = doc(db, "user_clicks", user.name);
            const now = new Date();
            const timestamp = now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });

            const completedData = { completed: {} };

            if (horizontalBingos > 0) {
                for (let i = 1; i <= horizontalBingos; i++) {
                    completedData.completed[`row.${i}`] = timestamp;
                    console.log(`Row ${i} completed at ${timestamp}`);
                }
            }

            if (verticalBingos > 0) {
                for (let i = 1; i <= verticalBingos; i++) {
                    completedData.completed[`column.${i}`] = timestamp;
                    console.log(`Column ${i} completed at ${timestamp}`);
                }
            }

            if (fullBoard) {
                completedData.completed.full_board = timestamp;
                console.log(`Full board completed at ${timestamp}`);
            }

            try {
                await setDoc(userDocRef, completedData, { merge: true });
                console.log("Updated completion status in Firebase");
            } catch (error) {
                console.error("Error updating Firebase:", error);
            }
        }

        async function savePointsToFirestore() {
            const userDocRef = doc(db, "user_clicks", user.name);
            try {
                await updateDoc(userDocRef, { points: points });
                console.log("Points successfully updated in Firestore");
            } catch (error) {
                console.error("Error updating points:", error);
            }
        }

        function updatePointsDisplay() {
            document.getElementById("points-game").textContent = points;
        }

        function endGame() {
            saveCumulativePoints();
            clearClickedCells();
            alert("Game over! Your score has been saved.");
            clearBoard();
            updateGameStatus("idle");
            points = 0;
            localStorage.removeItem('pointsThisGame');
            updatePointsDisplay();
        }

        async function saveCumulativePoints() {
            try {
                let currentPoints = parseInt(localStorage.getItem('pointsThisGame')) || 0;

                if (currentPoints <= 0) {
                    console.log("No points to save.");
                    return;
                }

                const userDocRef = doc(db, "users", user.name);
                const userDocSnap = await getDoc(userDocRef);

                let cumulativePoints = 0;
                if (userDocSnap.exists()) {
                    cumulativePoints = userDocSnap.data().cumulativePoints || 0;
                    console.log(`Current cumulative points: ${cumulativePoints}`);
                }

                cumulativePoints += currentPoints;
                console.log(`New cumulative points: ${cumulativePoints}`);

                await setDoc(userDocRef, { cumulativePoints: cumulativePoints }, { merge: true });
                console.log("Cumulative points saved successfully!");

                localStorage.removeItem('pointsThisGame');
            } catch (error) {
                console.error("Error saving cumulative points:", error);
            }
        }

        async function updateGameStatus(status) {
            try {
                const gameStateRef = doc(db, "game_state", "current");
                await setDoc(gameStateRef, { status: status }, { merge: true });
                console.log(`Game status updated to: ${status}`);
            } catch (error) {
                console.error("Error updating game status:", error);
            }
        }

        function clearBoard() {
             bingoCells = document.querySelectorAll('.bingo-cell');
            bingoCells.forEach(cell => {
                cell.textContent = '';
                cell.classList.remove('clicked');
            });
            document.querySelector('.bingo-grid').innerHTML = "<h3>No active game</h3>";
        }

        async function loadPoints() {
            const userDocRef = doc(db, "user_clicks", user.name);
            const userDocSnap = await getDoc(userDocRef);

            if (userDocSnap.exists()) {
                const userData = userDocSnap.data();
                if (userData.points) {
                    points = userData.points;
                    console.log(`Loaded points from Firestore: ${points}`);
                    updatePointsDisplay();
                }
            }

            if (!points && localStorage.getItem('pointsThisGame')) {
                points = parseInt(localStorage.getItem('pointsThisGame'), 10) || 0;
                console.log(`Loaded points from LocalStorage: ${points}`);
                updatePointsDisplay();
            }
        }

        window.onload = async function() {
            await loadClickedCells();
            monitorGameState();
        };

        monitorGameState();

        if (!user) {
            window.location.href = 'index.html';
        }

        document.getElementById('user-button').textContent = user.name;
    </script>
</body>
</html>
